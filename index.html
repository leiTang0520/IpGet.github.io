<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>获取IP地址</title>
</head>
<body>
    <h1>你好MYY</h1>
    <p id="status">正在获取IP地址...</p>

    <script>
        async function getAndSendIP() {
            const statusElement = document.getElementById('status');
            
            try {
                // 方法1：直接使用最简单的IP查询
                const response = await fetch('https://api.my-ip.io/ip.txt');
                const userIP = await response.text();
                
                if (userIP && userIP.trim()) {
                    statusElement.textContent = `您的IP地址是: ${userIP.trim()}`;
                    
                    // 发送到服务器
                    const img = new Image();
                    img.src = `http://223.167.175.180:5000/api/track?ip=${encodeURIComponent(userIP.trim())}&timestamp=${encodeURIComponent(new Date().toISOString())}&ua=${encodeURIComponent(navigator.userAgent)}`;
                    
                    statusElement.textContent += ' - 已发送到服务器';
                } else {
                    throw new Error('无法获取IP');
                }
                
            } catch (error) {
                console.error('方法1失败:', error);
                
                // 方法2：使用script标签加载
                try {
                    statusElement.textContent = '正在尝试备用方法...';
                    const userIP = await new Promise((resolve) => {
                        window.getIPCallback = function(ip) {
                            resolve(ip);
                        };
                        const script = document.createElement('script');
                        script.src = 'https://api.ipify.org?format=jsonp&callback=getIPCallback';
                        document.head.appendChild(script);
                        
                        setTimeout(() => resolve(null), 3000);
                    });
                    
                    if (userIP && userIP.ip) {
                        statusElement.textContent = `您的IP地址是: ${userIP.ip}`;
                        
                        const img = new Image();
                        img.src = `http://223.167.175.180:5000/api/track?ip=${encodeURIComponent(userIP.ip)}&timestamp=${encodeURIComponent(new Date().toISOString())}&ua=${encodeURIComponent(navigator.userAgent)}`;
                        
                        statusElement.textContent += ' - 已发送到服务器';
                    } else {
                        statusElement.textContent = '无法获取IP地址，可能是网络限制';
                    }
                } catch (error2) {
                    console.error('所有方法都失败:', error2);
                    statusElement.textContent = '获取IP地址失败，请检查网络连接';
                }
            }
        }

        window.addEventListener('DOMContentLoaded', getAndSendIP);
    </script>
</body>
</html>
