<!DOCTYPE html>
<html>
<head>
    <title>IP收集器</title>
</head>
<body>
    <h1>IP地址收集</h1>
    <button onclick="getAndSendIP()">获取并发送我的IP</button>
    <div id="result"></div>

    <script>
        // 你的服务器地址 - 替换为你的实际IP和端口
        const SERVER_URL = 'http://223.167.175.180:5000/api/collect-ip';

        // 获取IP地址的函数
        async function getIPAddress() {
            // 方法1: 使用 ipify API (推荐)
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                console.log('方法1失败:', error);
            }

            // 方法2: 备用方案
            try {
                const response = await fetch('https://api64.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                console.log('方法2失败:', error);
            }

            // 方法3: 另一个备用方案
            try {
                const response = await fetch('https://ipapi.co/json/');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                console.log('方法3失败:', error);
            }

            return '未知';
        }

        // 发送IP到服务器的函数
        async function sendIPToServer(ip) {
            try {
                const response = await fetch(SERVER_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        ip: ip,
                        timestamp: new Date().toISOString(),
                        userAgent: navigator.userAgent
                    })
                });
                
                const result = await response.json();
                return result;
            } catch (error) {
                console.error('发送失败:', error);
                throw error;
            }
        }

        // 主函数：获取IP并发送
        async function getAndSendIP() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '正在获取IP地址...';
            
            try {
                // 获取IP
                const ip = await getIPAddress();
                resultDiv.innerHTML = `获取到IP: ${ip}<br>正在发送到服务器...`;
                
                // 发送到服务器
                const serverResponse = await sendIPToServer(ip);
                
                resultDiv.innerHTML = `
                    <h3>✅ 发送成功!</h3>
                    <p>你的IP地址: <strong>${ip}</strong></p>
                    <p>服务器响应: ${serverResponse.message}</p>
                    <p>时间: ${new Date().toLocaleString()}</p>
                `;
                
                console.log('发送成功:', serverResponse);
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <h3>❌ 发送失败</h3>
                    <p>错误信息: ${error.message}</p>
                    <p>请检查网络连接或服务器状态</p>
                `;
                console.error('发送失败:', error);
            }
        }

        // 页面加载时自动执行（可选）
        // window.onload = getAndSendIP;
    </script>
</body>
</html>
